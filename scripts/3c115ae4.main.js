var app=app||{},MAX_POINTS=1e3;app.gmlEditor=function(){var a,b,c,d,e=[],f=-1,g=function(c,d){var g=new Date;-1===f&&(f=g);var h=g-f;e.push({x:c/a,y:d/b,z:0,t:h}),$("#m-points").html(MAX_POINTS-e.length)},h=function(a){e.forEach(function(b){b.t=b.t/(a-f)})},i=function(c){function d(){c.size(a,b),c.background(245,246,243),c.stroke(0),console.log("setting up")}function f(){m(),c.fill(0),c.ellipse(c.mouseX-1,c.mouseY-1,2,2),g(c.mouseX,c.mouseY),console.log(e)}function i(){e.length>=MAX_POINTS||(c.fill(0),c.ellipse(c.mouseX-1,c.mouseY-1,2,2),g(c.mouseX,c.mouseY))}function j(){var a=new Date;h(a)}c.setup=d,c.mousePressed=f,c.mouseDragged=i,c.mouseReleased=j},j=function(){var a=new X2JS,b={};b={tag:{drawing:{stroke:{pt:[]}}}},e.forEach(function(a){b.tag.drawing.stroke.pt.push(a)});{var c='<gml spec="1.0">'+a.json2xml_str(b)+"</gml>";({gml:c,time:Date.now()})}return c},k=function(){},l=function(f,g,h,j){var l=document.getElementById(f);if(l){c=document.createElement("canvas"),$(l).append('<div id="m-pointcount"><span id="m-points"></span> points left</div>'),l.appendChild(c),a=h||500,b=j||500,d=g||k,$("#m-points").html(MAX_POINTS-e.length);{new Processing(c,i)}}},m=function(){e=[],f=-1;var d=c.getContext("2d");d.fillStyle="rgb(245,246,243)",d.fillRect(0,0,a,b)},n=function(){return e};return{init:l,getGML:j,clear:m,getPoints:n}}();var GmlCanvas=function(a,b){"use strict";this.clear(),this.containerId=a;var c={drawingFun:{},width:500,height:500,backgroundColor:[245,246,243],strokeColor:[0,0,0]};this.settings=utils.merge(c,b)};GmlCanvas.prototype.render=function(a,b){"use strict";var c=this;this.duration=b;var d=document.getElementById(c.containerId);if(d){this.canvas=document.createElement("canvas");var e=_.template($("#drawing-card-template").html()),f=$(e()).appendTo(d);$(f).append(this.canvas),this.points=a.tag.drawing.stroke.pt;{new Processing(c.canvas,c._sketch(),c)}}},GmlCanvas.prototype.clear=function(){"use strict";if(this.canvas){var a=this.canvas.getContext("2d");a.fillStyle="rgb(245,245,246)",a.fillRect(0,0,this.settings.width,this.settings.height)}},GmlCanvas.prototype._sketch=function(){"use strict";var a=this;return function(b){function c(){b.size(a.settings.width,a.settings.height),b.background.apply(b,a.settings.backgroundColor),b.stroke.apply(b,a.settings.strokeColor),b.fill.apply(b,a.settings.strokeColor),a.points.forEach(function(c,e){var f=c,g=e;0!==e&&!function(){setTimeout(function(){a.settings.drawingFun(b,f.x*a.settings.width-1,f.y*a.settings.height-1,a.points[g-1].x*a.settings.width-1,a.points[g-1].y*a.settings.height-1)},f.t*d)}()})}var d=a.duration;b.setup=c}};var app=app||{};app.form=function(){"use strict";var a=($("#moon-form"),function(){app.gmlEditor.init("draw-input",600,600),c()}),b=function(){var a=d(),b=e(a,function(){});b?f(a):!1},c=function(){$(".erase").on("click",function(){app.gmlEditor.clear()}),$(".anon").on("click",function(){console.log("click"),b(),app.gmlEditor.clear()})},d=function(){var a=$("#m-textarea").val(),b=(app.gmlEditor.getPoints(),{text:a||"",pts:app.gmlEditor.getGML()}),c={age:"#m-age",name:"#m-name",country:"#m-country"};for(var d in c)b[d]=$(c[d]).val();return b},e=function(a){return console.log(a),a.text||0!==app.gmlEditor.getPoints().length?!0:!1},f=function(a){console.log("uploading"),a&&(a.time=Date.now(),console.log("saving "+JSON.stringify(a)))};return{init:a}}(),app.form.init();